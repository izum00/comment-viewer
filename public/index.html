<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YouTube Live Chat Viewer - Tech Edition</title>
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #151b2a;
      --bg-tertiary: #1e2538;
      --border-color: #2a3249;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.05) 0%, transparent 20%);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      color: white;
    }
    
    .logo-text h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    
    .logo-text p {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    .controls-panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel-title::before {
      content: '';
      width: 4px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 2px;
    }
    
    .pip-button {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .pip-button:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      box-shadow: 0 0 12px var(--accent-glow);
    }
    
    .url-input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    #url {
      flex: 1;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 15px;
      transition: all 0.2s;
    }
    
    #url:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    #url::placeholder {
      color: var(--text-muted);
    }
    
    .control-buttons {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-connect {
      background: var(--accent-primary);
      color: white;
      flex: 1;
    }
    
    .btn-connect:hover {
      background: #2563eb;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-disconnect {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-disconnect:hover {
      background: var(--border-color);
    }
    
    .chat-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      height: 500px;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .chat-header {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .chat-stats {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .online-indicator {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É™„É≥„Ç∞ */
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) var(--bg-tertiary);
    }
    
    /* Webkit„Éñ„É©„Ç¶„Ç∂Áî®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„Çπ„Çø„Ç§„É´ */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }
    
    .message {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      border-left: 4px solid var(--border-color);
      transition: all 0.2s;
      animation: fadeIn 0.3s ease-out;
    }
    
    .message:hover {
      border-left-color: var(--accent-primary);
      background: rgba(30, 37, 56, 0.8);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid var(--border-color);
    }
    
    .author-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .message-content {
      flex: 1;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .author-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 15px;
    }
    
    .author-badge {
      font-size: 12px;
      padding: 2px 8px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .message-text {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
    }
    
    .custom-emoji {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin: 0 2px;
    }
    
    .message-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    
    .meta-message {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      border-left: 4px solid var(--text-muted);
      text-align: center;
    }
    
    .error-message {
      border-left-color: var(--error);
      color: var(--error);
    }
    
    .success-message {
      border-left-color: var(--success);
      color: var(--success);
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .status-bar {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    /* „Çπ„ÇØ„É≠„Éº„É´„ÉÄ„Ç¶„É≥„Éú„Çø„É≥ */
    .scroll-to-bottom {
      position: absolute;
      bottom: 80px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      z-index: 100;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    
    .scroll-to-bottom.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .scroll-to-bottom:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .url-input-container {
        flex-direction: column;
      }
      
      .control-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .scroll-to-bottom {
        bottom: 70px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <h1>YouTube Live Chat</h1>
          <p>Tech Edition ‚Ä¢ „É™„Ç¢„É´„Çø„Ç§„É†„ÉÅ„É£„ÉÉ„Éà„Éì„É•„Éº„Ç¢„Éº</p>
        </div>
      </div>
    </header>
    
    <div class="controls-panel">
      <div class="panel-header">
        <div class="panel-title">Êé•Á∂ö„Ç≥„É≥„Éà„É≠„Éº„É´</div>
        <button id="pip-toggle" class="pip-button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
          </svg>
          PIP„Ç¶„Ç£„É≥„Éâ„Ç¶
        </button>
      </div>
      
      <div class="url-input-container">
        <input 
          type="text" 
          id="url" 
          placeholder="YouTube„É©„Ç§„ÉñURL„ÇíÂÖ•Âäõ (‰æã: https://www.youtube.com/watch?v=VIDEOID „Åæ„Åü„ÅØ VIDEOID„ÅÆ„Åø)"
        />
      </div>
      
      <div class="control-buttons">
        <button id="connect" class="btn btn-connect">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Êé•Á∂ö
        </button>
        <button id="disconnect" class="btn btn-disconnect">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
          ÂàáÊñ≠
        </button>
      </div>
    </div>
    
    <div class="chat-container" id="chat-window">
      <div class="chat-header">
        <div class="chat-title">„É©„Ç§„Éñ„ÉÅ„É£„ÉÉ„Éà</div>
        <div class="chat-stats">
          <div class="online-indicator"></div>
          <span id="message-count">0 „É°„ÉÉ„Çª„Éº„Ç∏</span>
        </div>
      </div>
      
      <div id="chat">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <h3>„ÉÅ„É£„ÉÉ„Éà„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</h3>
          <p>YouTube„É©„Ç§„ÉñURL„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåÊé•Á∂ö„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>
      </div>
      
      <!-- „Çπ„ÇØ„É≠„Éº„É´„ÉÄ„Ç¶„É≥„Éú„Çø„É≥ -->
      <button id="scroll-to-bottom" class="scroll-to-bottom" title="ÊúÄÊñ∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å∏">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </svg>
      </button>
      
      <div class="status-bar">
        <div id="status">Êú™Êé•Á∂ö</div>
        <div id="timestamp">--:--:--</div>
      </div>
    </div>
  </div>
<script>
// Áä∂ÊÖãÁÆ°ÁêÜ
const state = {
    messageCount: 0,
    isConnected: false,
    currentVideoId: null,
    pipWindow: null,
    pipIsNative: false,
    autoScrollEnabled: true,
    userScrolledUp: false,
    ws: null,
    isConnecting: false
};

// DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
const chat = document.getElementById('chat');
const urlInput = document.getElementById('url');
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');
const pipToggleBtn = document.getElementById('pip-toggle');
const messageCountEl = document.getElementById('message-count');
const statusEl = document.getElementById('status');
const timestampEl = document.getElementById('timestamp');
const chatWindow = document.getElementById('chat-window');
const scrollToBottomBtn = document.getElementById('scroll-to-bottom');

// WebSocketÊé•Á∂öÈñ¢Êï∞
function connectWebSocket() {
    if (state.ws && (state.ws.readyState === WebSocket.OPEN || state.ws.readyState === WebSocket.CONNECTING)) {
        return state.ws;
    }
    
    state.ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
    
    state.ws.onopen = () => {
        state.isConnected = true;
        state.isConnecting = false;
        statusEl.textContent = 'Êé•Á∂öÊ∏à„Åø';
        statusEl.style.color = 'var(--success)';
        addMetaMessage('WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
        
        // Êé•Á∂öÂæå„Å´videoId„ÇíÈÄÅ‰ø°
        if (state.currentVideoId) {
            state.ws.send(JSON.stringify({ type: 'connect', videoId: state.currentVideoId }));
            addSuccessMessage(`YouTube Live„Å´Êé•Á∂ö‰∏≠: ${state.currentVideoId}`);
            statusEl.textContent = 'YouTube„Å´Êé•Á∂ö‰∏≠...';
        }
    };
    
    state.ws.onclose = () => {
        state.isConnected = false;
        state.isConnecting = false;
        statusEl.textContent = 'Êú™Êé•Á∂ö';
        statusEl.style.color = 'var(--text-secondary)';
        addMetaMessage('WebSocket„Çµ„Éº„Éê„Éº„Åã„ÇâÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü');
    };
    
    state.ws.onerror = (e) => {
        state.isConnecting = false;
        addErrorMessage(`WebSocket„Ç®„É©„Éº: ${e.message}`);
    };
    
    state.ws.onmessage = (ev) => {
        try {
            const data = JSON.parse(ev.data);
            displayMessage(data);
        } catch (e) {
            // Áîü„Éá„Éº„Çø„ÅåÊù•„ÅüÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (ev.data.includes('"type":"chat"')) {
                try {
                    const data = JSON.parse(ev.data);
                    displayMessage(data);
                } catch (parseError) {
                    addErrorMessage(`„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº: ${parseError.message}`);
                }
            } else {
                addMetaMessage(ev.data);
            }
        }
    };
    
    return state.ws;
}

// WebSocketÂàáÊñ≠Èñ¢Êï∞
function disconnectWebSocket() {
    if (state.ws) {
        if (state.ws.readyState === WebSocket.OPEN) {
            state.ws.send(JSON.stringify({ type: 'disconnect' }));
        }
        state.ws.close();
        state.ws = null;
    }
    state.isConnected = false;
    state.isConnecting = false;
    state.currentVideoId = null;
}

// „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
function displayMessage(data) {
    try {
        // „Éö„Ç§„É≠„Éº„Éâ„ÅåÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØ„Éë„Éº„Çπ
        const payload = typeof data.payload === 'string' ? 
            JSON.parse(data.payload) : data.payload;
        
        // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà
        if (data.type === 'chat' && payload.type === 'AddChatItemAction') {
            const item = payload.item;
            
            // „ÉÜ„Ç≠„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÂá¶ÁêÜ
            if (item.type === 'LiveChatTextMessage') {
                state.messageCount++;
                updateStats();
                
                // „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„Çí‰ΩúÊàê
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                
                // ÊäïÁ®øËÄÖÊÉÖÂ†±
                const author = item.author;
                const timestamp = new Date(parseInt(item.timestamp_usec) / 1000);
                
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÉÜ„Ç≠„Çπ„Éà„ÅÆÊßãÁØâ
                let messageText = '';
                let plainText = ''; // PIPÁî®„ÅÆ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà
                if (item.message && item.message.runs) {
                    item.message.runs.forEach(run => {
                        if (run.text) {
                            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂ†¥Âêà
                            plainText += run.text;
                            
                            if (run.emoji && run.emoji.is_custom) {
                                // „Ç´„Çπ„Çø„É†ÁµµÊñáÂ≠ó„ÅÆÂ†¥Âêà
                                const emoji = run.emoji;
                                let emojiUrl = '';
                                
                                // ÊúÄÈÅ©„Å™„Çµ„Ç§„Ç∫„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû
                                if (emoji.image && emoji.image.length > 0) {
                                    // 24x24„ÅÆÁîªÂÉè„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ÊúÄÂàù„ÅÆÁîªÂÉè„Çí‰ΩøÁî®
                                    const smallImg = emoji.image.find(img => img.width === 24 && img.height === 24);
                                    emojiUrl = smallImg ? smallImg.url : emoji.image[0].url;
                                }
                                
                                if (emojiUrl) {
                                    messageText += `<img src="${emojiUrl}" alt="${emoji.shortcuts ? emoji.shortcuts[0] : 'emoji'}" class="custom-emoji">`;
                                } else if (emoji.emoji_id) {
                                    messageText += emoji.emoji_id;
                                    plainText += emoji.emoji_id;
                                }
                            } else {
                                // ÈÄöÂ∏∏„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
                                messageText += run.text;
                            }
                        } else if (run.emoji) {
                            // run.text„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆÁµµÊñáÂ≠óÂá¶ÁêÜÔºàÊóßÂΩ¢ÂºèÔºâ
                            const emoji = run.emoji;
                            let emojiUrl = '';
                            
                            if (emoji.image && emoji.image.length > 0) {
                                // 24x24„ÅÆÁîªÂÉè„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ÊúÄÂàù„ÅÆÁîªÂÉè„Çí‰ΩøÁî®
                                const smallImg = emoji.image.find(img => img.width === 24 && img.height === 24);
                                emojiUrl = smallImg ? smallImg.url : emoji.image[0].url;
                            }
                            
                            if (emojiUrl) {
                                messageText += `<img src="${emojiUrl}" alt="${emoji.shortcuts ? emoji.shortcuts[0] : 'emoji'}" class="custom-emoji">`;
                            } else if (emoji.emoji_id) {
                                messageText += emoji.emoji_id;
                                plainText += emoji.emoji_id;
                            }
                        }
                    });
                }
                
                // „Éê„ÉÉ„Ç∏„ÅÆÂèñÂæó
                let badgeText = '';
                if (author.badges && author.badges.length > 0) {
                    const badge = author.badges[0];
                    if (badge.tooltip) {
                        badgeText = badge.tooltip;
                    } else if (badge.type === 'LiveChatAuthorBadge') {
                        badgeText = '„É°„É≥„Éê„Éº';
                    }
                }
                
                // „Ç¢„Éê„Çø„ÉºURLÔºàÂ∞è„Åï„ÅÑ„Çµ„Ç§„Ç∫„ÇíÂÑ™ÂÖàÔºâ
                const avatarUrl = author.thumbnails && author.thumbnails[1] ? 
                    author.thumbnails[1].url : 
                    (author.thumbnails && author.thumbnails[0] ? author.thumbnails[0].url : '');
                
                // „É°„ÉÉ„Çª„Éº„Ç∏HTML„ÅÆÊßãÁØâ
                messageEl.innerHTML = `
                    <div class="author-avatar">
                        ${avatarUrl ? `<img src="${avatarUrl}" alt="${author.name}" crossorigin="anonymous">` : 
                            `<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${author.name ? author.name.charAt(0) : '?'}</div>`}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="author-name">${author.name || 'ÂåøÂêç„É¶„Éº„Ç∂„Éº'}</span>
                            ${badgeText ? `<span class="author-badge">${badgeText}</span>` : ''}
                        </div>
                        <div class="message-text">${messageText || '(„É°„ÉÉ„Çª„Éº„Ç∏„Å™„Åó)'}</div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    </div>
                `;
                
                // Êó¢Â≠ò„ÅÆÁ©∫Áä∂ÊÖã„ÇíÂâäÈô§
                const emptyState = chat.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                // „ÉÅ„É£„ÉÉ„Éà„Å´ËøΩÂä†
                chat.appendChild(messageEl);
                
                // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅÆ„Åø‰∏ÄÁï™‰∏ã„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
                if (state.autoScrollEnabled && !state.userScrolledUp) {
                    scrollToBottom();
                } else {
                    // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅåÁÑ°Âäπ„Å™„Çâ„Éú„Çø„É≥„ÇíË°®Á§∫
                    updateScrollButton();
                }
            }
        } 
        // „É°„ÇøÊÉÖÂ†±„ÅÆÂ†¥Âêà
        else if (data.type === 'meta' || data.type === 'meta-update') {
            addMetaMessage(data.message || '„É°„ÇøÊÉÖÂ†±„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü');
        }
        // „Ç®„É©„Éº„ÅÆÂ†¥Âêà
        else if (data.type === 'error') {
            addErrorMessage(data.message || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
    } catch (error) {
        console.error('„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç®„É©„Éº:', error);
        addErrorMessage(`„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº: ${error.message}`);
    }
}

// ‰∏ÄÁï™‰∏ã„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
    state.userScrolledUp = false;
    state.autoScrollEnabled = true;
    updateScrollButton();
}

// „Çπ„ÇØ„É≠„Éº„É´„Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
function updateScrollButton() {
    const scrollThreshold = 100;
    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight <= scrollThreshold;
    
    if (!isNearBottom && chat.children.length > 0) {
        state.autoScrollEnabled = false;
        scrollToBottomBtn.classList.add('visible');
    } else {
        scrollToBottomBtn.classList.remove('visible');
    }
}

// „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
chat.addEventListener('scroll', () => {
    const scrollThreshold = 100;
    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight <= scrollThreshold;
    
    if (!isNearBottom) {
        state.userScrolledUp = true;
        state.autoScrollEnabled = false;
    }
    
    updateScrollButton();
});

// „Çπ„ÇØ„É≠„Éº„É´„ÉÄ„Ç¶„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
scrollToBottomBtn.addEventListener('click', () => {
    scrollToBottom();
});

// „É°„Çø„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
function addMetaMessage(text) {
    const metaEl = document.createElement('div');
    metaEl.className = 'meta-message';
    metaEl.textContent = text;
    chat.appendChild(metaEl);
    
    // „É°„Çø„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇËá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆÂØæË±°
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
function addErrorMessage(text) {
    const errorEl = document.createElement('div');
    errorEl.className = 'meta-message error-message';
    errorEl.textContent = text;
    chat.appendChild(errorEl);
    
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
function addSuccessMessage(text) {
    const successEl = document.createElement('div');
    successEl.className = 'meta-message success-message';
    successEl.textContent = text;
    chat.appendChild(successEl);
    
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatTime(date) {
    return date.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
function updateStats() {
    messageCountEl.textContent = `${state.messageCount} „É°„ÉÉ„Çª„Éº„Ç∏`;
    timestampEl.textContent = new Date().toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Êé•Á∂ö„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
connectBtn.onclick = () => {
    const url = urlInput.value.trim();
    if (!url) {
        addErrorMessage('YouTube„É©„Ç§„ÉñURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    // URL„Åã„ÇâvideoId„ÇíÊäΩÂá∫
    let videoId = null;
    try {
        const u = new URL(url);
        videoId = u.searchParams.get('v') || u.pathname.split('/').pop();
    } catch {
        // URL„Åß„Å™„ÅÑÂ†¥Âêà„ÅØvideoId„Å®„Åø„Å™„Åô
        videoId = url;
    }
    
    if (!videoId) {
        addErrorMessage('ÊúâÂäπ„Å™Video ID„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
        return;
    }
    
    state.currentVideoId = videoId;
    
    if (!state.isConnected || state.isConnecting) {
        // WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÊé•Á∂ö
        if (state.ws && (state.ws.readyState === WebSocket.CLOSING || state.ws.readyState === WebSocket.CLOSED)) {
            disconnectWebSocket();
        }
        
        state.isConnecting = true;
        statusEl.textContent = 'Êé•Á∂ö‰∏≠...';
        addMetaMessage('WebSocket„Å´Êé•Á∂ö‰∏≠...');
        
        connectWebSocket();
    } else if (state.isConnected) {
        // Êó¢„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØvideoId„ÅÆ„ÅøÈÄÅ‰ø°
        state.ws.send(JSON.stringify({ type: 'connect', videoId }));
        addSuccessMessage(`YouTube Live„Å´Êé•Á∂ö‰∏≠: ${videoId}`);
        statusEl.textContent = 'YouTube„Å´Êé•Á∂ö‰∏≠...';
    }
};

// ÂàáÊñ≠„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
disconnectBtn.onclick = () => {
    if (state.isConnected || state.isConnecting) {
        disconnectWebSocket();
        addMetaMessage('Êé•Á∂ö„ÇíÂàáÊñ≠„Åó„Åæ„Åó„Åü');
        statusEl.textContent = 'Êú™Êé•Á∂ö';
        statusEl.style.color = 'var(--text-secondary)';
    }
};

// PIP„Ç¶„Ç£„É≥„Éâ„Ç¶Ê©üËÉΩ
pipToggleBtn.onclick = async () => {
    if (state.pipWindow && !state.pipWindow.closed) {
        // PIP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÊó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
        if (state.pipIsNative && state.pipWindow.close) {
            state.pipWindow.close();
        } else if (!state.pipWindow.closed) {
            state.pipWindow.close();
        }
        state.pipWindow = null;
        state.pipIsNative = false;
        pipToggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
            </svg>
            PIP„Ç¶„Ç£„É≥„Éâ„Ç¶
        `;
        addMetaMessage('PIP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Åæ„Åó„Åü');
    } else {
        // Document Picture-in-Picture API„ÇíË©¶„Åô
        if ('documentPictureInPicture' in window) {
            try {
                const pipWindow = await documentPictureInPicture.requestWindow({
                    width: 400,
                    height: 600
                });
                
                // PiP„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏ÂÖ®‰Ωì„Çíiframe„ÅßË°®Á§∫
                pipWindow.document.body.innerHTML = `
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            background: #0a0e17;
                            overflow: hidden;
                            width: 100%;
                            height: 100vh;
                        }
                        #pip-iframe {
                            width: 100%;
                            height: 100%;
                            border: none;
                            background: #0a0e17;
                        }
                        .pip-controls {
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            z-index: 1000;
                            display: flex;
                            gap: 5px;
                            opacity: 0;
                            transition: opacity 0.3s;
                        }
                        .pip-controls:hover {
                            opacity: 1;
                        }
                        .pip-control-btn {
                            background: rgba(59, 130, 246, 0.8);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            width: 30px;
                            height: 30px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            backdrop-filter: blur(5px);
                        }
                    </style>
                    <iframe 
                        id="pip-iframe" 
                        src="${window.location.href}"
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                        allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"
                    ></iframe>
                    <div class="pip-controls">
                        <button id="pip-refresh" class="pip-control-btn" title="ÂÜçË™≠„ÅøËæº„Åø">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                        <button id="pip-close" class="pip-control-btn" title="Èñâ„Åò„Çã">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    <script>
                        const iframe = document.getElementById('pip-iframe');
                        const refreshBtn = document.getElementById('pip-refresh');
                        const closeBtn = document.getElementById('pip-close');
                        
                        refreshBtn.addEventListener('click', () => {
                            iframe.src = iframe.src;
                        });
                        
                        closeBtn.addEventListener('click', () => {
                            window.close();
                        });
                        
                        // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ëª¢ÈÄÅ
                        window.addEventListener('message', function(event) {
                            iframe.contentWindow.postMessage(event.data, '*');
                        });
                    <\/script>
                `;
                
                state.pipWindow = pipWindow;
                state.pipIsNative = true;
                pipToggleBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                    PIP„ÇíÈñâ„Åò„Çã
                `;
                
                addSuccessMessage('„Éç„Ç§„ÉÜ„Ç£„ÉñPIP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åç„Åæ„Åó„Åü');
                
                // PiP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈñâ„Åò„Çâ„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
                pipWindow.addEventListener('pagehide', () => {
                    state.pipWindow = null;
                    state.pipIsNative = false;
                    pipToggleBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
                        </svg>
                        PIP„Ç¶„Ç£„É≥„Éâ„Ç¶
                    `;
                });
                
                return;
            } catch (error) {
                console.warn('Native PiP failed:', error);
                addMetaMessage('„Éç„Ç§„ÉÜ„Ç£„ÉñPIP„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ‰ª£ÊõøÊñπÊ≥ï„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
            }
        }
        
        // „Éç„Ç§„ÉÜ„Ç£„ÉñPiP„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åè
        const pipWindow = window.open('', 'YouTubeLiveChatPIP', 
            `width=600,height=800,left=${window.screenLeft + 20},top=${window.screenTop + 20},resizable=yes,scrollbars=yes`);
        
        if (!pipWindow) {
            addErrorMessage('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }
        
        // PIP„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏ÂÖ®‰Ωì„Çíiframe„ÅßË°®Á§∫
        pipWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>YouTube Live Chat - PIP</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        background: #0a0e17;
                        overflow: hidden;
                        width: 100%;
                        height: 100vh;
                        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                    }
                    #pip-iframe {
                        width: 100%;
                        height: 100%;
                        border: none;
                        background: #0a0e17;
                    }
                    .pip-controls {
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        z-index: 1000;
                        display: flex;
                        gap: 5px;
                        opacity: 0;
                        transition: opacity 0.3s;
                    }
                    .pip-controls:hover {
                        opacity: 1;
                    }
                    .pip-control-btn {
                        background: rgba(59, 130, 246, 0.8);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        backdrop-filter: blur(5px);
                    }
                    .pip-control-btn:hover {
                        background: rgba(59, 130, 246, 1);
                    }
                </style>
            </head>
            <body>
                <iframe 
                    id="pip-iframe" 
                    src="${window.location.href}"
                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                    allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"
                ></iframe>
                <div class="pip-controls">
                    <button id="pip-refresh" class="pip-control-btn" title="ÂÜçË™≠„ÅøËæº„Åø">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                    </button>
                    <button id="pip-close" class="pip-control-btn" title="Èñâ„Åò„Çã">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                <script>
                    const iframe = document.getElementById('pip-iframe');
                    const refreshBtn = document.getElementById('pip-refresh');
                    const closeBtn = document.getElementById('pip-close');
                    
                    refreshBtn.addEventListener('click', () => {
                        iframe.src = iframe.src;
                    });
                    
                    closeBtn.addEventListener('click', () => {
                        window.close();
                    });
                    
                    // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ëª¢ÈÄÅ
                    window.addEventListener('message', function(event) {
                        iframe.contentWindow.postMessage(event.data, '*');
                    });
                <\/script>
            </body>
            </html>
        `);
        
        state.pipWindow = pipWindow;
        state.pipIsNative = false;
        pipToggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
            PIP„ÇíÈñâ„Åò„Çã
        `;
        
        addSuccessMessage('PIP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åç„Åæ„Åó„Åü');
        
        // PIP„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈñâ„Åò„Çâ„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
        const checkPIPClosed = setInterval(() => {
            if (state.pipWindow && state.pipWindow.closed) {
                clearInterval(checkPIPClosed);
                state.pipWindow = null;
                state.pipIsNative = false;
                pipToggleBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
                    </svg>
                    PIP„Ç¶„Ç£„É≥„Éâ„Ç¶
                `;
            }
        }, 1000);
    }
};

// ÂàùÊúüÂåñ
updateStats();
addMetaMessage('YouTube„É©„Ç§„Éñ„ÉÅ„É£„ÉÉ„Éà„Éì„É•„Éº„Ç¢„Éº„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü');

// ÂàùÊúüÁä∂ÊÖã„Åß‰∏ÄÁï™‰∏ã„Å´„Çπ„ÇØ„É≠„Éº„É´
setTimeout(() => {
    scrollToBottom();
}, 100);

// ÂÖ•Âäõ‰æã„ÇíË°®Á§∫
setTimeout(() => {
    urlInput.value = '';
    urlInput.placeholder = "‰æã: https://www.youtube.com/watch?v=VIDEOID";
}, 100);

// „Éö„Éº„Ç∏ÁµÇ‰∫ÜÊôÇ„Å´WebSocket„ÇíÂàáÊñ≠
window.addEventListener('beforeunload', () => {
    disconnectWebSocket();
});
  </script>
</body>
</html>
