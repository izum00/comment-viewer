<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YouTube Live Chat Viewer - Tech Edition</title>
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #151b2a;
      --bg-tertiary: #1e2538;
      --border-color: #2a3249;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.05) 0%, transparent 20%);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      color: white;
    }
    
    .logo-text h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    
    .logo-text p {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    .controls-panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel-title::before {
      content: '';
      width: 4px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 2px;
    }
    
    .pip-button {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .pip-button:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      box-shadow: 0 0 12px var(--accent-glow);
    }
    
    .url-input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    #url {
      flex: 1;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 15px;
      transition: all 0.2s;
    }
    
    #url:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    #url::placeholder {
      color: var(--text-muted);
    }
    
    .control-buttons {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-connect {
      background: var(--accent-primary);
      color: white;
      flex: 1;
    }
    
    .btn-connect:hover {
      background: #2563eb;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-disconnect {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-disconnect:hover {
      background: var(--border-color);
    }
    
    .chat-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      height: 500px;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .chat-header {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .chat-stats {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .online-indicator {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) var(--bg-tertiary);
    }
    
    /* Webkitãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }
    
    .message {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      border-left: 4px solid var(--border-color);
      transition: all 0.2s;
      animation: fadeIn 0.3s ease-out;
    }
    
    .message:hover {
      border-left-color: var(--accent-primary);
      background: rgba(30, 37, 56, 0.8);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid var(--border-color);
    }
    
    .author-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .message-content {
      flex: 1;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .author-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 15px;
    }
    
    .author-badge {
      font-size: 12px;
      padding: 2px 8px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .message-text {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
    }
    
    .custom-emoji {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin: 0 2px;
    }
    
    .message-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    
    .meta-message {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      border-left: 4px solid var(--text-muted);
      text-align: center;
    }
    
    .error-message {
      border-left-color: var(--error);
      color: var(--error);
    }
    
    .success-message {
      border-left-color: var(--success);
      color: var(--success);
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .status-bar {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ */
    .scroll-to-bottom {
      position: absolute;
      bottom: 80px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      z-index: 100;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    
    .scroll-to-bottom.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .scroll-to-bottom:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .url-input-container {
        flex-direction: column;
      }
      
      .control-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .scroll-to-bottom {
        bottom: 70px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <h1>YouTube Live Chat</h1>
          <p>Tech Edition â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</p>
        </div>
      </div>
    </header>
    
    <div class="controls-panel">
      <div class="panel-header">
        <div class="panel-title">æ¥ç¶šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</div>
        <button id="pip-toggle" class="pip-button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
          </svg>
          PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
        </button>
      </div>
      
      <div class="url-input-container">
        <input 
          type="text" 
          id="url" 
          placeholder="YouTubeãƒ©ã‚¤ãƒ–URLã‚’å…¥åŠ› (ä¾‹: https://www.youtube.com/watch?v=VIDEOID ã¾ãŸã¯ VIDEOIDã®ã¿)"
        />
      </div>
      
      <div class="control-buttons">
        <button id="connect" class="btn btn-connect">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          æ¥ç¶š
        </button>
        <button id="disconnect" class="btn btn-disconnect">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
          åˆ‡æ–­
        </button>
      </div>
    </div>
    
    <div class="chat-container" id="chat-window">
      <div class="chat-header">
        <div class="chat-title">ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆ</div>
        <div class="chat-stats">
          <div class="online-indicator"></div>
          <span id="message-count">0 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
        </div>
      </div>
      
      <div id="chat">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’¬</div>
          <h3>ãƒãƒ£ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h3>
          <p>YouTubeãƒ©ã‚¤ãƒ–URLã‚’å…¥åŠ›ã—ã¦ã€Œæ¥ç¶šã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
        </div>
      </div>
      
      <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ -->
      <button id="scroll-to-bottom" class="scroll-to-bottom" title="æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </svg>
      </button>
      
      <div class="status-bar">
        <div id="status">æœªæ¥ç¶š</div>
        <div id="timestamp">--:--:--</div>
      </div>
    </div>
  </div>
<script>
// çŠ¶æ…‹ç®¡ç†
const state = {
    messageCount: 0,
    isConnected: false,
    currentVideoId: null,
    pipWindow: null,
    pipIsNative: false,
    autoScrollEnabled: true,
    userScrolledUp: false,
    ws: null,
    isConnecting: false
};

// DOMè¦ç´ ã®å–å¾—
const chat = document.getElementById('chat');
const urlInput = document.getElementById('url');
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');
const pipToggleBtn = document.getElementById('pip-toggle');
const messageCountEl = document.getElementById('message-count');
const statusEl = document.getElementById('status');
const timestampEl = document.getElementById('timestamp');
const chatWindow = document.getElementById('chat-window');
const scrollToBottomBtn = document.getElementById('scroll-to-bottom');

// WebSocketæ¥ç¶šé–¢æ•°
function connectWebSocket() {
    if (state.ws && (state.ws.readyState === WebSocket.OPEN || state.ws.readyState === WebSocket.CONNECTING)) {
        return state.ws;
    }
    
    state.ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
    
    state.ws.onopen = () => {
        state.isConnected = true;
        state.isConnecting = false;
        statusEl.textContent = 'æ¥ç¶šæ¸ˆã¿';
        statusEl.style.color = 'var(--success)';
        addMetaMessage('WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
        
        // æ¥ç¶šå¾Œã«videoIdã‚’é€ä¿¡
        if (state.currentVideoId) {
            state.ws.send(JSON.stringify({ type: 'connect', videoId: state.currentVideoId }));
            addSuccessMessage(`YouTube Liveã«æ¥ç¶šä¸­: ${state.currentVideoId}`);
            statusEl.textContent = 'YouTubeã«æ¥ç¶šä¸­...';
        }
    };
    
    state.ws.onclose = () => {
        state.isConnected = false;
        state.isConnecting = false;
        statusEl.textContent = 'æœªæ¥ç¶š';
        statusEl.style.color = 'var(--text-secondary)';
        addMetaMessage('WebSocketã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    };
    
    state.ws.onerror = (e) => {
        state.isConnecting = false;
        addErrorMessage(`WebSocketã‚¨ãƒ©ãƒ¼: ${e.message}`);
    };
    
    state.ws.onmessage = (ev) => {
        try {
            const data = JSON.parse(ev.data);
            displayMessage(data);
        } catch (e) {
            // ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒæ¥ãŸå ´åˆã®å‡¦ç†
            if (ev.data.includes('"type":"chat"')) {
                try {
                    const data = JSON.parse(ev.data);
                    displayMessage(data);
                } catch (parseError) {
                    addErrorMessage(`ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼: ${parseError.message}`);
                }
            } else {
                addMetaMessage(ev.data);
            }
        }
    };
    
    return state.ws;
}

// WebSocketåˆ‡æ–­é–¢æ•°
function disconnectWebSocket() {
    if (state.ws) {
        if (state.ws.readyState === WebSocket.OPEN) {
            state.ws.send(JSON.stringify({ type: 'disconnect' }));
        }
        state.ws.close();
        state.ws = null;
    }
    state.isConnected = false;
    state.isConnecting = false;
    state.currentVideoId = null;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
function displayMessage(data) {
    try {
        // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
        const payload = typeof data.payload === 'string' ? 
            JSON.parse(data.payload) : data.payload;
        
        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
        if (data.type === 'chat' && payload.type === 'AddChatItemAction') {
            const item = payload.item;
            
            // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å‡¦ç†
            if (item.type === 'LiveChatTextMessage') {
                state.messageCount++;
                updateStats();
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                
                // æŠ•ç¨¿è€…æƒ…å ±
                const author = item.author;
                const timestamp = new Date(parseInt(item.timestamp_usec) / 1000);
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã®æ§‹ç¯‰
                let messageText = '';
                let plainText = ''; // PIPç”¨ã®ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
                if (item.message && item.message.runs) {
                    item.message.runs.forEach(run => {
                        if (run.text) {
                            // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆ
                            plainText += run.text;
                            
                            if (run.emoji && run.emoji.is_custom) {
                                // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®å ´åˆ
                                const emoji = run.emoji;
                                let emojiUrl = '';
                                
                                // æœ€é©ãªã‚µã‚¤ã‚ºã®ç”»åƒã‚’é¸æŠ
                                if (emoji.image && emoji.image.length > 0) {
                                    // 24x24ã®ç”»åƒã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æœ€åˆã®ç”»åƒã‚’ä½¿ç”¨
                                    const smallImg = emoji.image.find(img => img.width === 24 && img.height === 24);
                                    emojiUrl = smallImg ? smallImg.url : emoji.image[0].url;
                                }
                                
                                if (emojiUrl) {
                                    messageText += `<img src="${emojiUrl}" alt="${emoji.shortcuts ? emoji.shortcuts[0] : 'emoji'}" class="custom-emoji">`;
                                } else if (emoji.emoji_id) {
                                    messageText += emoji.emoji_id;
                                    plainText += emoji.emoji_id;
                                }
                            } else {
                                // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆ
                                messageText += run.text;
                            }
                        } else if (run.emoji) {
                            // run.textãŒãªã„å ´åˆã®çµµæ–‡å­—å‡¦ç†ï¼ˆæ—§å½¢å¼ï¼‰
                            const emoji = run.emoji;
                            let emojiUrl = '';
                            
                            if (emoji.image && emoji.image.length > 0) {
                                // 24x24ã®ç”»åƒã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æœ€åˆã®ç”»åƒã‚’ä½¿ç”¨
                                const smallImg = emoji.image.find(img => img.width === 24 && img.height === 24);
                                emojiUrl = smallImg ? smallImg.url : emoji.image[0].url;
                            }
                            
                            if (emojiUrl) {
                                messageText += `<img src="${emojiUrl}" alt="${emoji.shortcuts ? emoji.shortcuts[0] : 'emoji'}" class="custom-emoji">`;
                            } else if (emoji.emoji_id) {
                                messageText += emoji.emoji_id;
                                plainText += emoji.emoji_id;
                            }
                        }
                    });
                }
                
                // ãƒãƒƒã‚¸ã®å–å¾—
                let badgeText = '';
                if (author.badges && author.badges.length > 0) {
                    const badge = author.badges[0];
                    if (badge.tooltip) {
                        badgeText = badge.tooltip;
                    } else if (badge.type === 'LiveChatAuthorBadge') {
                        badgeText = 'ãƒ¡ãƒ³ãƒãƒ¼';
                    }
                }
                
                // ã‚¢ãƒã‚¿ãƒ¼URLï¼ˆå°ã•ã„ã‚µã‚¤ã‚ºã‚’å„ªå…ˆï¼‰
                const avatarUrl = author.thumbnails && author.thumbnails[1] ? 
                    author.thumbnails[1].url : 
                    (author.thumbnails && author.thumbnails[0] ? author.thumbnails[0].url : '');
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸HTMLã®æ§‹ç¯‰
                messageEl.innerHTML = `
                    <div class="author-avatar">
                        ${avatarUrl ? `<img src="${avatarUrl}" alt="${author.name}" crossorigin="anonymous">` : 
                            `<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${author.name ? author.name.charAt(0) : '?'}</div>`}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="author-name">${author.name || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼'}</span>
                            ${badgeText ? `<span class="author-badge">${badgeText}</span>` : ''}
                        </div>
                        <div class="message-text">${messageText || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)'}</div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    </div>
                `;
                
                // æ—¢å­˜ã®ç©ºçŠ¶æ…‹ã‚’å‰Šé™¤
                const emptyState = chat.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                // ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
                chat.appendChild(messageEl);
                
                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (state.autoScrollEnabled && !state.userScrolledUp) {
                    scrollToBottom();
                } else {
                    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒç„¡åŠ¹ãªã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    updateScrollButton();
                }
                
                // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«è»¢é€
                sendToPIP({
                    author: author.name || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼',
                    text: plainText || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)',
                    formattedText: messageText || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)',
                    time: formatTime(timestamp),
                    badge: badgeText,
                    avatarUrl: avatarUrl
                });
            }
        } 
        // ãƒ¡ã‚¿æƒ…å ±ã®å ´åˆ
        else if (data.type === 'meta' || data.type === 'meta-update') {
            addMetaMessage(data.message || 'ãƒ¡ã‚¿æƒ…å ±ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
        }
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        else if (data.type === 'error') {
            addErrorMessage(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        addErrorMessage(`ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
    state.userScrolledUp = false;
    state.autoScrollEnabled = true;
    updateScrollButton();
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
function updateScrollButton() {
    const scrollThreshold = 100;
    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight <= scrollThreshold;
    
    if (!isNearBottom && chat.children.length > 0) {
        state.autoScrollEnabled = false;
        scrollToBottomBtn.classList.add('visible');
    } else {
        scrollToBottomBtn.classList.remove('visible');
    }
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
chat.addEventListener('scroll', () => {
    const scrollThreshold = 100;
    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight <= scrollThreshold;
    
    if (!isNearBottom) {
        state.userScrolledUp = true;
        state.autoScrollEnabled = false;
    }
    
    updateScrollButton();
});

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
scrollToBottomBtn.addEventListener('click', () => {
    scrollToBottom();
});

// ãƒ¡ã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
function addMetaMessage(text) {
    const metaEl = document.createElement('div');
    metaEl.className = 'meta-message';
    metaEl.textContent = text;
    chat.appendChild(metaEl);
    
    // ãƒ¡ã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å¯¾è±¡
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
function addErrorMessage(text) {
    const errorEl = document.createElement('div');
    errorEl.className = 'meta-message error-message';
    errorEl.textContent = text;
    chat.appendChild(errorEl);
    
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
function addSuccessMessage(text) {
    const successEl = document.createElement('div');
    successEl.className = 'meta-message success-message';
    successEl.textContent = text;
    chat.appendChild(successEl);
    
    if (state.autoScrollEnabled && !state.userScrolledUp) {
        scrollToBottom();
    } else {
        updateScrollButton();
    }
}

// æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatTime(date) {
    return date.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
function updateStats() {
    messageCountEl.textContent = `${state.messageCount} ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`;
    timestampEl.textContent = new Date().toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

// PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
function sendToPIP(messageData) {
    if (!state.pipWindow) return;
    
    if (state.pipIsNative) {
        // ãƒã‚¤ãƒ†ã‚£ãƒ–PiPã®å ´åˆ
        const pipChat = state.pipWindow.document.getElementById('pip-chat');
        if (pipChat) {
            const message = state.pipWindow.document.createElement('div');
            message.className = 'pip-message';
            
            // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            let avatarHtml = '';
            if (messageData.avatarUrl) {
                avatarHtml = `<div class="pip-avatar">
                    <img src="${messageData.avatarUrl}" alt="${messageData.author}" crossorigin="anonymous">
                </div>`;
            } else {
                const initial = messageData.author ? messageData.author.charAt(0) : '?';
                avatarHtml = `<div class="pip-avatar no-avatar">${initial}</div>`;
            }
            
            message.innerHTML = `
                ${avatarHtml}
                <div class="pip-content">
                    <div class="pip-author">${messageData.author} ${messageData.badge ? `<span class="pip-badge">${messageData.badge}</span>` : ''}</div>
                    <div class="pip-text">${messageData.formattedText || messageData.text}</div>
                    <div class="pip-time">${messageData.time}</div>
                </div>
            `;
            
            pipChat.appendChild(message);
            
            // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã¯è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒã§ãã‚‹ã‚ˆã†ã«ï¼‰
            const pipScrollThreshold = 50;
            const isPipNearBottom = pipChat.scrollHeight - pipChat.scrollTop - pipChat.clientHeight <= pipScrollThreshold;
            
            if (isPipNearBottom) {
                pipChat.scrollTop = pipChat.scrollHeight;
            }
        }
    } else if (!state.pipWindow.closed) {
        // é€šå¸¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å ´åˆ
        try {
            state.pipWindow.postMessage({
                type: 'chatMessage',
                ...messageData
            }, '*');
        } catch (error) {
            console.error('PIPè»¢é€ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
}

// æ¥ç¶šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
connectBtn.onclick = () => {
    const url = urlInput.value.trim();
    if (!url) {
        addErrorMessage('YouTubeãƒ©ã‚¤ãƒ–URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // URLã‹ã‚‰videoIdã‚’æŠ½å‡º
    let videoId = null;
    try {
        const u = new URL(url);
        videoId = u.searchParams.get('v') || u.pathname.split('/').pop();
    } catch {
        // URLã§ãªã„å ´åˆã¯videoIdã¨ã¿ãªã™
        videoId = url;
    }
    
    if (!videoId) {
        addErrorMessage('æœ‰åŠ¹ãªVideo IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }
    
    state.currentVideoId = videoId;
    
    if (!state.isConnected || state.isConnecting) {
        // WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ¥ç¶š
        if (state.ws && (state.ws.readyState === WebSocket.CLOSING || state.ws.readyState === WebSocket.CLOSED)) {
            disconnectWebSocket();
        }
        
        state.isConnecting = true;
        statusEl.textContent = 'æ¥ç¶šä¸­...';
        addMetaMessage('WebSocketã«æ¥ç¶šä¸­...');
        
        connectWebSocket();
    } else if (state.isConnected) {
        // æ—¢ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯videoIdã®ã¿é€ä¿¡
        state.ws.send(JSON.stringify({ type: 'connect', videoId }));
        addSuccessMessage(`YouTube Liveã«æ¥ç¶šä¸­: ${videoId}`);
        statusEl.textContent = 'YouTubeã«æ¥ç¶šä¸­...';
    }
};

// åˆ‡æ–­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
disconnectBtn.onclick = () => {
    if (state.isConnected || state.isConnecting) {
        disconnectWebSocket();
        addMetaMessage('æ¥ç¶šã‚’åˆ‡æ–­ã—ã¾ã—ãŸ');
        statusEl.textContent = 'æœªæ¥ç¶š';
        statusEl.style.color = 'var(--text-secondary)';
    }
};

// PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ©Ÿèƒ½
pipToggleBtn.onclick = async () => {
    if (state.pipWindow && !state.pipWindow.closed) {
        // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒæ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
        if (state.pipIsNative && state.pipWindow.close) {
            state.pipWindow.close();
        } else if (!state.pipWindow.closed) {
            state.pipWindow.close();
        }
        state.pipWindow = null;
        state.pipIsNative = false;
        pipToggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
            </svg>
            PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
        `;
        addMetaMessage('PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¾ã—ãŸ');
    } else {
        // Document Picture-in-Picture APIã‚’è©¦ã™
        if ('documentPictureInPicture' in window) {
            try {
                const pipWindow = await documentPictureInPicture.requestWindow({
                    width: 400,
                    height: 600
                });
                
                // PiPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
                pipWindow.document.body.innerHTML = `
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                            background: #0a0e17;
                            color: #e2e8f0;
                            margin: 0;
                            padding: 0;
                        }
                        .pip-header {
                            background: #151b2a;
                            padding: 12px 16px;
                            border-bottom: 1px solid #2a3249;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        }
                        .pip-title {
                            font-weight: 600;
                            font-size: 14px;
                        }
                        #pip-chat {
                            height: calc(100vh - 45px);
                            overflow-y: auto;
                            padding: 16px;
                            scrollbar-width: thin;
                            scrollbar-color: #2a3249 #1e2538;
                        }
                        #pip-chat::-webkit-scrollbar {
                            width: 6px;
                        }
                        #pip-chat::-webkit-scrollbar-track {
                            background: #1e2538;
                            border-radius: 3px;
                        }
                        #pip-chat::-webkit-scrollbar-thumb {
                            background: #2a3249;
                            border-radius: 3px;
                        }
                        #pip-chat::-webkit-scrollbar-thumb:hover {
                            background: #3b82f6;
                        }
                        .pip-message {
                            background: #1e2538;
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 12px;
                            display: flex;
                            gap: 10px;
                            align-items: flex-start;
                            animation: fadeIn 0.3s ease-out;
                        }
                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(5px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        .pip-avatar {
                            width: 32px;
                            height: 32px;
                            border-radius: 6px;
                            overflow: hidden;
                            flex-shrink: 0;
                            border: 1px solid #2a3249;
                        }
                        .pip-avatar img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }
                        .pip-avatar.no-avatar {
                            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 14px;
                        }
                        .pip-content {
                            flex: 1;
                            min-width: 0;
                        }
                        .pip-author {
                            font-weight: 600;
                            font-size: 13px;
                            margin-bottom: 4px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        .pip-badge {
                            font-size: 10px;
                            padding: 1px 4px;
                            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                            color: white;
                            border-radius: 3px;
                            font-weight: 500;
                        }
                        .pip-text {
                            font-size: 14px;
                            color: #94a3b8;
                            line-height: 1.4;
                            word-break: break-word;
                        }
                        .pip-emoji {
                            width: 20px;
                            height: 20px;
                            vertical-align: middle;
                            margin: 0 1px;
                        }
                        .pip-time {
                            font-size: 11px;
                            color: #64748b;
                            margin-top: 4px;
                            text-align: right;
                        }
                        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ */
                        .pip-scroll-to-bottom {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                            transition: all 0.2s;
                            z-index: 100;
                            opacity: 0;
                            transform: translateY(20px);
                            pointer-events: none;
                        }
                        .pip-scroll-to-bottom.visible {
                            opacity: 1;
                            transform: translateY(0);
                            pointer-events: all;
                        }
                        .pip-scroll-to-bottom:hover {
                            background: #2563eb;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
                        }
                    </style>
                    <div class="pip-header">
                        <div class="pip-title">YouTube Live Chat PIP</div>
                        <div style="font-size: 12px; color: #94a3b8;">${state.currentVideoId || 'æœªæ¥ç¶š'}</div>
                    </div>
                    <div id="pip-chat">
                        <div style="text-align: center; color: #64748b; padding: 20px; font-size: 13px;">
                            PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦<br>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                        </div>
                    </div>
                    <button id="pip-scroll-to-bottom" class="pip-scroll-to-bottom" title="æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                        </svg>
                    </button>
                    <script>
                        // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ç®¡ç†
                        const pipState = {
                            autoScrollEnabled: true,
                            userScrolledUp: false
                        };
                        
                        const pipChat = document.getElementById('pip-chat');
                        const pipScrollBtn = document.getElementById('pip-scroll-to-bottom');
                        
                        // ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹é–¢æ•°
                        function pipScrollToBottom() {
                            pipChat.scrollTop = pipChat.scrollHeight;
                            pipState.userScrolledUp = false;
                            pipState.autoScrollEnabled = true;
                            updatePIPScrollButton();
                        }
                        
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
                        function updatePIPScrollButton() {
                            const scrollThreshold = 100;
                            const isNearBottom = pipChat.scrollHeight - pipChat.scrollTop - pipChat.clientHeight <= scrollThreshold;
                            
                            if (!isNearBottom && pipChat.children.length > 0) {
                                pipState.autoScrollEnabled = false;
                                pipScrollBtn.classList.add('visible');
                            } else {
                                pipScrollBtn.classList.remove('visible');
                            }
                        }
                        
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                        pipChat.addEventListener('scroll', () => {
                            const scrollThreshold = 100;
                            const isNearBottom = pipChat.scrollHeight - pipChat.scrollTop - pipChat.clientHeight <= scrollThreshold;
                            
                            if (!isNearBottom) {
                                pipState.userScrolledUp = true;
                                pipState.autoScrollEnabled = false;
                            }
                            
                            updatePIPScrollButton();
                        });
                        
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                        pipScrollBtn.addEventListener('click', () => {
                            pipScrollToBottom();
                        });
                        
                        // åˆæœŸçŠ¶æ…‹ã§ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        setTimeout(() => {
                            pipScrollToBottom();
                        }, 100);
                        
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                        window.addEventListener('message', function(event) {
                            if (event.data.type === 'chatMessage') {
                                const message = document.createElement('div');
                                message.className = 'pip-message';
                                
                                // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                                let avatarHtml = '';
                                if (event.data.avatarUrl) {
                                    avatarHtml = \`<div class="pip-avatar">
                                        <img src="\${event.data.avatarUrl}" alt="\${event.data.author}" crossorigin="anonymous">
                                    </div>\`;
                                } else {
                                    const initial = event.data.author ? event.data.author.charAt(0) : '?';
                                    avatarHtml = \`<div class="pip-avatar no-avatar">\${initial}</div>\`;
                                }
                                
                                // çµµæ–‡å­—ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†
                                const textWithEmojis = event.data.formattedText.replace(
                                    /<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/g,
                                    (match, src, alt) => \`<img src="\${src}" alt="\${alt}" class="pip-emoji">\`
                                );
                                
                                message.innerHTML = \`
                                    \${avatarHtml}
                                    <div class="pip-content">
                                        <div class="pip-author">\${event.data.author} \${event.data.badge ? \`<span class="pip-badge">\${event.data.badge}</span>\` : ''}</div>
                                        <div class="pip-text">\${textWithEmojis}</div>
                                        <div class="pip-time">\${event.data.time}</div>
                                    </div>
                                \`;
                                
                                pipChat.appendChild(message);
                                
                                // æ—¢å­˜ã®ç©ºçŠ¶æ…‹ã‚’å‰Šé™¤
                                const emptyState = pipChat.querySelector('.empty-state');
                                if (emptyState) {
                                    emptyState.remove();
                                }
                                
                                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                                if (pipState.autoScrollEnabled && !pipState.userScrolledUp) {
                                    pipScrollToBottom();
                                } else {
                                    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒç„¡åŠ¹ãªã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                                    updatePIPScrollButton();
                                }
                            }
                        });
                    <\/script>
                `;
                
                state.pipWindow = pipWindow;
                state.pipIsNative = true;
                pipToggleBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                    PIPã‚’é–‰ã˜ã‚‹
                `;
                
                addSuccessMessage('ãƒã‚¤ãƒ†ã‚£ãƒ–PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ');
                
                // PiPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã®å‡¦ç†
                pipWindow.addEventListener('pagehide', () => {
                    state.pipWindow = null;
                    state.pipIsNative = false;
                    pipToggleBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
                        </svg>
                        PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
                    `;
                });
                
                return;
            } catch (error) {
                console.warn('Native PiP failed:', error);
                addMetaMessage('ãƒã‚¤ãƒ†ã‚£ãƒ–PIPã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»£æ›¿æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
            }
        }
        
        // ãƒã‚¤ãƒ†ã‚£ãƒ–PiPãŒä½¿ãˆãªã„å ´åˆã¯é€šå¸¸ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        const pipWindow = window.open('', 'YouTubeLiveChatPIP', 
            `width=400,height=600,left=${window.screenLeft + 20},top=${window.screenTop + 20}`);
        
        if (!pipWindow) {
            addErrorMessage('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
        pipWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>YouTube Live Chat - PIP</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                        background: #0a0e17;
                        color: #e2e8f0;
                        margin: 0;
                        padding: 0;
                    }
                    .pip-header {
                        background: #151b2a;
                        padding: 12px 16px;
                        border-bottom: 1px solid #2a3249;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }
                    .pip-title {
                        font-weight: 600;
                        font-size: 14px;
                    }
                    #pip-chat {
                        height: calc(100vh - 45px);
                        overflow-y: auto;
                        padding: 16px;
                        scrollbar-width: thin;
                        scrollbar-color: #2a3249 #1e2538;
                    }
                    #pip-chat::-webkit-scrollbar {
                        width: 6px;
                    }
                    #pip-chat::-webkit-scrollbar-track {
                        background: #1e2538;
                        border-radius: 3px;
                    }
                    #pip-chat::-webkit-scrollbar-thumb {
                        background: #2a3249;
                        border-radius: 3px;
                    }
                    #pip-chat::-webkit-scrollbar-thumb:hover {
                        background: #3b82f6;
                    }
                    .pip-message {
                        background: #1e2538;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 12px;
                        display: flex;
                        gap: 10px;
                        align-items: flex-start;
                        animation: fadeIn 0.3s ease-out;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(5px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .pip-avatar {
                        width: 32px;
                        height: 32px;
                        border-radius: 6px;
                        overflow: hidden;
                        flex-shrink: 0;
                        border: 1px solid #2a3249;
                    }
                    .pip-avatar img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    .pip-avatar.no-avatar {
                        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 14px;
                    }
                    .pip-content {
                        flex: 1;
                        min-width: 0;
                    }
                    .pip-author {
                        font-weight: 600;
                        font-size: 13px;
                        margin-bottom: 4px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    .pip-badge {
                        font-size: 10px;
                        padding: 1px 4px;
                        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                        color: white;
                        border-radius: 3px;
                        font-weight: 500;
                    }
                    .pip-text {
                        font-size: 14px;
                        color: #94a3b8;
                        line-height: 1.4;
                        word-break: break-word;
                    }
                    .pip-emoji {
                        width: 20px;
                        height: 20px;
                        vertical-align: middle;
                        margin: 0 1px;
                    }
                    .pip-time {
                        font-size: 11px;
                        color: #64748b;
                        margin-top: 4px;
                        text-align: right;
                    }
                    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ */
                    .pip-scroll-to-bottom {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        transition: all 0.2s;
                        z-index: 100;
                        opacity: 0;
                        transform: translateY(20px);
                        pointer-events: none;
                    }
                    .pip-scroll-to-bottom.visible {
                        opacity: 1;
                        transform: translateY(0);
                        pointer-events: all;
                    }
                    .pip-scroll-to-bottom:hover {
                        background: #2563eb;
                        transform: translateY(-2px);
                        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
                    }
                </style>
            </head>
            <body>
                <div class="pip-header">
                    <div class="pip-title">YouTube Live Chat PIP</div>
                    <div style="font-size: 12px; color: #94a3b8;">${state.currentVideoId || 'æœªæ¥ç¶š'}</div>
                </div>
                <div id="pip-chat">
                    <div style="text-align: center; color: #64748b; padding: 20px; font-size: 13px;">
                        PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦<br>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                <button id="pip-scroll-to-bottom" class="pip-scroll-to-bottom" title="æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </button>
                <script>
                    // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ç®¡ç†
                    const pipState = {
                        autoScrollEnabled: true,
                        userScrolledUp: false
                    };
                    
                    const pipChat = document.getElementById('pip-chat');
                    const pipScrollBtn = document.getElementById('pip-scroll-to-bottom');
                    
                    // ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹é–¢æ•°
                    function pipScrollToBottom() {
                        pipChat.scrollTop = pipChat.scrollHeight;
                        pipState.userScrolledUp = false;
                        pipState.autoScrollEnabled = true;
                        updatePIPScrollButton();
                    }
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
                    function updatePIPScrollButton() {
                        const scrollThreshold = 100;
                        const isNearBottom = pipChat.scrollHeight - pipChat.scrollTop - pipChat.clientHeight <= scrollThreshold;
                        
                        if (!isNearBottom && pipChat.children.length > 0) {
                            pipState.autoScrollEnabled = false;
                            pipScrollBtn.classList.add('visible');
                        } else {
                            pipScrollBtn.classList.remove('visible');
                        }
                    }
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    pipChat.addEventListener('scroll', () => {
                        const scrollThreshold = 100;
                        const isNearBottom = pipChat.scrollHeight - pipChat.scrollTop - pipChat.clientHeight <= scrollThreshold;
                        
                        if (!isNearBottom) {
                            pipState.userScrolledUp = true;
                            pipState.autoScrollEnabled = false;
                        }
                        
                        updatePIPScrollButton();
                    });
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                    pipScrollBtn.addEventListener('click', () => {
                        pipScrollToBottom();
                    });
                    
                    // åˆæœŸçŠ¶æ…‹ã§ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    setTimeout(() => {
                        pipScrollToBottom();
                    }, 100);
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    window.addEventListener('message', function(event) {
                        if (event.data.type === 'chatMessage') {
                            const message = document.createElement('div');
                            message.className = 'pip-message';
                            
                            // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                            let avatarHtml = '';
                            if (event.data.avatarUrl) {
                                avatarHtml = \`<div class="pip-avatar">
                                    <img src="\${event.data.avatarUrl}" alt="\${event.data.author}" crossorigin="anonymous">
                                </div>\`;
                            } else {
                                const initial = event.data.author ? event.data.author.charAt(0) : '?';
                                avatarHtml = \`<div class="pip-avatar no-avatar">\${initial}</div>\`;
                            }
                            
                            // çµµæ–‡å­—ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†
                            const textWithEmojis = event.data.formattedText.replace(
                                /<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/g,
                                (match, src, alt) => \`<img src="\${src}" alt="\${alt}" class="pip-emoji">\`
                            );
                            
                            message.innerHTML = \`
                                \${avatarHtml}
                                <div class="pip-content">
                                    <div class="pip-author">\${event.data.author} \${event.data.badge ? \`<span class="pip-badge">\${event.data.badge}</span>\` : ''}</div>
                                    <div class="pip-text">\${textWithEmojis}</div>
                                    <div class="pip-time">\${event.data.time}</div>
                                </div>
                            \`;
                            
                            pipChat.appendChild(message);
                            
                            // æ—¢å­˜ã®ç©ºçŠ¶æ…‹ã‚’å‰Šé™¤
                            const emptyState = pipChat.querySelector('.empty-state');
                            if (emptyState) {
                                emptyState.remove();
                            }
                            
                            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                            if (pipState.autoScrollEnabled && !pipState.userScrolledUp) {
                                pipScrollToBottom();
                            } else {
                                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒç„¡åŠ¹ãªã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                                updatePIPScrollButton();
                            }
                        }
                    });
                <\/script>
            </body>
            </html>
        `);
        
        state.pipWindow = pipWindow;
        state.pipIsNative = false;
        pipToggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
            PIPã‚’é–‰ã˜ã‚‹
        `;
        
        addSuccessMessage('PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ');
        
        // PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã®å‡¦ç†
        const checkPIPClosed = setInterval(() => {
            if (state.pipWindow && state.pipWindow.closed) {
                clearInterval(checkPIPClosed);
                state.pipWindow = null;
                state.pipIsNative = false;
                pipToggleBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 11h-8v6h8v-6zm4-8v18H1V3h22zm-2 16H3V5h18v14z"/>
                    </svg>
                    PIPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
                `;
            }
        }, 1000);
    }
};

// åˆæœŸåŒ–
updateStats();
addMetaMessage('YouTubeãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ');

// åˆæœŸçŠ¶æ…‹ã§ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
setTimeout(() => {
    scrollToBottom();
}, 100);

// å…¥åŠ›ä¾‹ã‚’è¡¨ç¤º
setTimeout(() => {
    urlInput.value = '';
    urlInput.placeholder = "ä¾‹: https://www.youtube.com/watch?v=VIDEOID";
}, 100);

// ãƒšãƒ¼ã‚¸çµ‚äº†æ™‚ã«WebSocketã‚’åˆ‡æ–­
window.addEventListener('beforeunload', () => {
    disconnectWebSocket();
});
  </script>
</body>
</html>
